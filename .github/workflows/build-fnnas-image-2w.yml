name: Build OrangePi Zero 2W Driver

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y gcc-aarch64-linux-gnu build-essential bc bison flex libssl-dev libelf-dev
    
    - name: Get Kernel Source
      run: |
        git clone --depth=1 https://github.com/orangepi-xunlong/linux-orangepi -b orange-pi-6.1-sun50iw9
        
    - name: Set Up Cross Compilation
      run: |
        cd linux-orangepi
        
        # 设置环境变量
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        
        # 验证
        echo "=== Toolchain info ==="
        $CROSS_COMPILEgcc --version
        
    - name: Configure Kernel
      run: |
        cd linux-orangepi
        
        # 配置内核
        make ${{ env.CROSS_COMPILE }} linux_sunxi64_defconfig
        
        # 启用sunxi_geth
        echo "CONFIG_SUNXI_GETH=y" >> .config
        echo "CONFIG_NET_VENDOR_ALLWINNER=y" >> .config
        
        # 更新配置
        make ${{ env.CROSS_COMPILE }} olddefconfig
        
        # 检查配置
        grep SUNXI_GETH .config
        
    - name: Build Driver
      run: |
        cd linux-orangepi
        
        # 准备编译环境
        make ${{ env.CROSS_COMPILE }} modules_prepare
        
        # 编译特定驱动
        echo "=== Building allwinner ethernet drivers ==="
        make ${{ env.CROSS_COMPILE }} M=drivers/net/ethernet/allwinner/
        
        # 检查结果
        if [ -f "drivers/net/ethernet/allwinner/sunxi-geth.ko" ]; then
            echo "✅ Driver found"
            mkdir -p ../output/drivers
            cp drivers/net/ethernet/allwinner/sunxi-geth.ko ../output/drivers/
        else
            echo "❌ Driver not found, listing all .ko files:"
            find drivers/net/ethernet/allwinner -name "*.ko" 2>/dev/null
        fi
        
    - name: Prepare DTB
      run: |
        cd linux-orangepi
        
        # 查找DTS文件
        echo "=== Looking for DTS files ==="
        find arch/arm64/boot/dts -name "*h61[68]*" -o -name "*zero2*" 2>/dev/null
        
        # 创建输出目录
        mkdir -p ../output/dtb/allwinner
        
        # 尝试编译DTB
        if [ -f "arch/arm64/boot/dts/allwinner/sun50i-h618-orangepi-zero2w.dts" ]; then
            echo "Compiling DTS..."
            make ${{ env.CROSS_COMPILE }} dtbs
            cp arch/arm64/boot/dts/allwinner/sun50i-h618-orangepi-zero2w.dtb ../output/dtb/allwinner/ 2>/dev/null || true
        fi
        
        # 如果失败，尝试其他文件名
        if [ ! -f "../output/dtb/allwinner/sun50i-h618-orangepi-zero2w.dtb" ]; then
            find arch/arm64/boot/dts/allwinner -name "*.dtb" | grep -i "h61\|zero" | head -5 | while read dtb; do
                echo "Copying: $(basename $dtb)"
                cp "$dtb" ../output/dtb/allwinner/
            done
        fi
        
    - name: Check Results
      run: |
        echo "=== Build Results ==="
        echo "Drivers:"
        ls -la output/drivers/ 2>/dev/null || echo "No drivers"
        
        echo "DTB files:"
        ls -la output/dtb/allwinner/ 2>/dev/null || echo "No DTB files"
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: orangepi-drivers
        path: output/
